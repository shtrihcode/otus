Vagrant.configure("2") do |config|
    config.vm.provider "virtualbox" do |v| 
    v.memory = 1024
    config.vm.box = "centos/7"
    end 
    
       #master
    config.vm.define "master" do |master|
    master.vm.box = "bento/centos-stream-8"
    master.vm.host_name = 'master'
    master.vm.network :private_network, ip: '192.168.11.150'
    master.vm.provision "shell", inline: <<-SHELL
           mkdir -p ~root/.ssh
           cp ~vagrant/.ssh/auth* ~root/.ssh
         SHELL
   
         master.vm.provision :shell do |s|
            s.inline = <<-SHELL
            mkdir -p ~root/.ssh; cp ~vagrant/.ssh/auth* ~root/.ssh
            sudo yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm -y
            sudo percona-release setup ps57
            sudo yum install Percona-Server-server-57 -y
            cp /vagrant/conf/conf.d/* /etc/my.cnf.d/
            systemctl start mysql
            pwd=$(cat /var/log/mysqld.log | grep 'root@localhost:' | awk '{print $11}')
            MYSQLPWD="P@ssw0rd"
            echo "ALTER USER USER() IDENTIFIED BY '$MYSQLPWD'" | mysql -uroot -p$pwd --connect-expired-password
            #echo "CREATE DATABASE bet" | mysql -uroot -p$MYSQLPWD
            #mysql -uroot -p$MYSQLPWD -D bet < /vagrant/bet.dmp
            SHELL
         end
         
         
         if boxconfig[:vm_name] == "master"
            box.trigger.after :up do |trigger|
                trigger.run = { inline: <<-SHELL
                echo "CREATE DATABASE bet" | mysql -uroot -p$MYSQLPWD
                mysql -uroot -p$MYSQLPWD -D bet < /vagrant/bet.dmp
                echo "CREATE USER 'repl'@'%' IDENTIFIED BY '!OtusLinux2023'" | mysql -uroot -p$MYSQLPWD
                echo "GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY '!OtusLinux2023'" | mysql -uroot -p$MYSQLPWD
                SHELL
                }
            end   
           end
     
         
         box.trigger.after :up do |trigger|
            trigger.run = { inline: <<-SHELL
            echo "CREATE DATABASE bet" | mysql -uroot -p$MYSQLPWD
            mysql -uroot -p$MYSQLPWD -D bet < /vagrant/bet.dmp
            echo "CREATE USER 'repl'@'%' IDENTIFIED BY '!OtusLinux2023'" | mysql -uroot -p$MYSQLPWD
            echo "GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%' IDENTIFIED BY '!OtusLinux2018'" | mysql -uroot -p$MYSQLPWD
            SHELL
            }
        end   
       end





      
        master.trigger.after :up do |trigger|
            trigger.run = { inline: 
              "vagrant ssh master -- cp /vagrant/.vagrant/machines/master/virtualbox/private_key ~/.ssh/id_rsa"
            }
        end
          box.vm.provision :shell do |s|
             s.inline = <<-SHELL
             mkdir -p ~root/.ssh; cp ~vagrant/.ssh/auth* ~root/.ssh
             sudo yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm -y
             sudo percona-release setup ps57
             sudo yum install Percona-Server-server-57 -y
             cp /vagrant/conf/conf.d/* /etc/my.cnf.d/
             systemctl start mysql
             pwd=$(cat /var/log/mysqld.log | grep 'root@localhost:' | awk '{print $11}')
             MYSQLPWD="P@ssw0rd"
             echo "ALTER USER USER() IDENTIFIED BY '$MYSQLPWD'" | mysql -uroot -p$pwd --connect-expired-password
             #echo "CREATE DATABASE bet" | mysql -uroot -p$MYSQLPWD
             #mysql -uroot -p$MYSQLPWD -D bet < /vagrant/bet.dmp
             SHELL
             